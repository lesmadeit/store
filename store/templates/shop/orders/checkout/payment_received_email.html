{% extends '../../../base.html' %}
{% load static %}
{% block title %}Payment{% endblock title %}
{% block content %}
<style>
  /* General section styling */
  .section-padding {
    padding: 50px 0;
  }

  /* Dark background for payment section */
  .bg-dark {
    background-color: #1c1427;
    color: #fff;
  }

  /* Card panel for billing and order sections */
  .card-panel {
    background-color: #fff;
    border-radius: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  /* Padding for card panels */
  .padding60 {
    padding: 30px;
  }

  /* Accent colors for titles and links */
  .title-accent {
    color: #f4cca4;
  }

  .link-accent {
    color: #d99879;
    text-decoration: none;
  }

  .link-accent:hover {
    color: #f4cca4;
  }

  .text-accent {
    color: #d99879;
  }

  /* Table styling for billing address */
  .payment-table {
    width: 100%;
    font-size: 15px;
    border-collapse: collapse;
  }

  .payment-table th,
  .payment-table td {
    padding: 10px;
    text-align: left;
  }

  .payment-table th {
    font-weight: 600;
    color: #333;
  }

  .payment-table td {
    color: #555;
  }

  /* Add black borders between rows */
  .payment-table tbody tr {
    border-bottom: 1px solid #000;
    /* Black border between rows */
  }

  .payment-table tbody tr:last-child {
    border-bottom: none;
    /* Remove border from last row */
  }

  /* Table styling for order details */
  .order-table {
    width: 100%;
    border-collapse: collapse;
  }

  .order-table thead th {
    background-color: #ffffff;
    color: #f4cca4;
    padding: 12px;
    font-weight: 600;
    border-radius: 20px 20px 0 0;
  }

  .order-table tbody th,
  .order-table tbody td {
    padding: 12px;
    border-bottom: 1px solid #000;
    /* Changed from #dee2e6 to black */
  }

  .order-table tbody th {
    font-weight: 600;
    color: #333;
  }

  .order-table tbody td {
    color: #555;
  }

  .order-table tbody tr:last-child th,
  .order-table tbody tr:last-child td {
    color: #d99879;
    border-bottom: none;
    /* Remove border from last row */
  }

  /* Payment method heading */
  .payment-method {
    font-size: 15px;
    margin-left: 30px;
    color: #333;
    font-weight: 600;
  }

  /* Button styling */
  .btn-accent {
    
    color: #1c1427;
    text-transform: capitalize;
    font-size: 15px;
    font-weight: bold;
    border: none;
    transition: background-color 0.3s ease;
  }

  .btn-accent:hover {
    
    color: #fff;
  }

  /* Center text for log-title */
  .log-title {
    margin-bottom: 20px;
  }

  /* Ensure responsiveness for smaller screens */
  @media (max-width: 576px) {
    .padding60 {
      padding: 20px;
    }

    .payment-table th,
    .payment-table td,
    .order-table th,
    .order-table td {
      font-size: 14px;
    }

    .payment-method {
      margin-left: 15px;
    }
  }
</style>
<!-- pages-title-start -->
<br><br><br>
<!-- pages-title-end -->
<!-- Payment content section start -->
<section class="pages checkout section-padding bg-dark">
  <div class="container">
    <div class="row">
      <div class="col-12 col-sm-6">
        <div class="card-panel padding60">
          <div class="log-title text-center">
            <h2><strong style="color: black;" class="text-accent">Billing Address</strong></h2>
          </div>
          <div class="cart-form-text pay-details table-responsive text-center">
            <table class="table payment-table">
              <tbody>
                <tr>
                  <th style="color: black;">Name:</th>
                  <td>{{ order.full_name }}</td>
                </tr>
                <tr>
                  <th style="color: black;">Order Number:</th>
                  <td>{{ order.order_number }}</td>
                </tr>
                <tr>
                  <th style="color: black;">Email:</th>
                  <td>{{ order.email }}</td>
                </tr>
                <tr>
                  <th style="color: black;">Phone Number:</th>
                  <td>{{ order.phone }}</td>
                </tr>
                {% if order.order_note %}
                <tr>
                  <th style="color: black;">Order Note:</th>
                  <td>{{ order.order_note }}</td>
                </tr>
                {% endif %}
              </tbody>
            </table>

          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6">
        <div class="card-panel padding60">
          <div class="log-title text-center">
            <h2><strong style="color: black;" class="text-accent">Order</strong></h2>
          </div>
          <div class="cart-form-text pay-details table-responsive text-center">
            <table class="table order-table">
              <thead>
                <tr>
                  <th style="color: black;"><b>Product</b></th>
                  <th style="color: black;"><b>Total<b></th>
                </tr>
              </thead>
              <tbody>
                {% for cart_item in cart_items %}
                <tr>
                  <th style="color: #333;">{{ cart_item.product.name }} x {{ cart_item.quantity }}</th>
                  <td>Ksh {{ cart_item.sub_total }}</td>
                </tr>
                {% endfor %}
                <tr>
                  <th style="color: #333;">Order Total</th>
                  <td style="color: #333;">Ksh {{ order_total }}</td>
                </tr>
              </tbody>
            </table>
            <div class="submit-text">
              <button id="mpesa-pay-btn" class="btn btn-primary btn-accent w-100">Make payment with M-Pesa</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var csrftoken = getCookie('csrftoken');
  var amount = "{{ order_total }}";
  var orderID = "{{ order.order_number }}";
  var payment_method = "Mpesa";
  var phone = "{{ order.phone }}";
  var stkPushUrl = "https://8155579dab07.ngrok-free.app/orders/online/lipa/";
  var checkStatusUrl = "https://8155579dab07.ngrok-free.app/orders/query/";
  var redirect_url = "{% url 'orders:order_complete' %}";
  var checkout = ""

  document.getElementById("mpesa-pay-btn").addEventListener("click", function () {
    initiateSTKPush();
  });

  function initiateSTKPush() {
    fetch(stkPushUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        orderID: orderID,
        amount: amount,
        phone: phone,
      }),
    })
      .then(response => {
        if (!response.ok) {
          console.error(`STK Push initiation failed with status: ${response.status}`);
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("STK Push initiated:", data);
        if (!data.CheckoutRequestID) {
          console.error("No CheckoutRequestID in response:", data);
          alert("Failed to initiate payment. Please try again.");
          return;
        }
        checkout = data.CheckoutRequestID;
        console.log("CheckoutRequestID set to:", checkout);
        alert("Confirmation prompt sent to your phone. Please enter your PIN to confirm the payment.");
        checkSTKPushStatus();
      })
      .catch(error => {
        console.error("STK Push error:", error);
        alert("An error occurred while initiating the payment. Please try again.");
      });
  }
  function checkSTKPushStatus() {
    console.log("Starting STK status polling for CheckoutRequestID:", checkout);
    if (!checkout) {
      console.error("CheckoutRequestID is missing!");
      alert("Payment initiation failed. Please try again.");
      return;
    }

    let attempts = 0;
    const maxAttempts = 6; // Stop after ~2 minutes (6 * 20 seconds)
    let interval = setInterval(() => {
      attempts++;
      console.log(`Polling STK status (attempt ${attempts})...`);
      if (!checkout) {
        console.error("CheckoutRequestID is still missing, stopping polling.");
        clearInterval(interval);
        alert("Payment initiation failed. Please try again.");
        return;
      }
      fetch(checkStatusUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          checkout: checkout
        }),
      })
        .then(response => {
          if (!response.ok) {
            console.error(`HTTP error! Status: ${response.status}`);
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("STK Callback Response:", data);
          let resultDesc = data.ResultDesc;
          let transactionID = checkout;

          console.log("Exact ResultDesc:", resultDesc);

          let normalizedDesc = resultDesc.toLowerCase().replace(/[.!]/g, "").trim();

          if (normalizedDesc === "the service request is processed successfully") {
            clearInterval(interval);
            console.log("Showing alert: Payment successful");
            alert("Payment successful!");
            sendData(transactionID);
          } else if (normalizedDesc === "request cancelled by user") {
            clearInterval(interval);
            console.log("Showing alert: Request cancelled by user");
            alert("Request cancelled by user");
          } else if (normalizedDesc === "ds timeout user cannot be reached") {
            clearInterval(interval);
            console.log("Showing alert: DS timeout");
            alert("DS timeout user cannot be reached");
          } else if (normalizedDesc === "the balance is insufficient for the transaction") {
            clearInterval(interval);
            console.log("Showing alert: Insufficient balance");
            alert("The balance is insufficient for the transaction.");
          } else if (attempts >= maxAttempts) {
            clearInterval(interval);
            console.log("Max polling attempts reached");
            alert("Payment status check timed out. Please try again.");
          }
        })
        .catch(error => {
          console.error("Callback error:", error);
          clearInterval(interval);
          alert("An error occurred while checking payment status.");
        });
    }, 20000);
  }
  function sendData(transactionID) {
    fetch("{% url 'orders:payments' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({
        orderID: orderID,
        transID: transactionID,
        payment_method: "Mpesa",
        status: "Completed",
      }),
    })
      .then(response => response.json())
      .then(data => {
        window.location.href = redirect_url + "?order_number=" + data.order_number + "&payment_id=" + data.transID;
      })
      .catch(error => console.error("Error saving payment:", error));
  }
</script>
<br>
{% endblock %}